name: Build

on:
  push:
    branches: [ "stable" ]
  pull_request:
    branches: [ "stable" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  Linux:
    name: Building on Ubuntu. 
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Rust Update
      run: rustup update
        
    - name: Rust Cache
      uses: Swatinem/rust-cache@v2.2.1
      
    - name: Build Release
      run: |
        cargo update
        #time cargo br
        time cargo lto
        ls -hl target/*/BL
        lscpu
        free -m
        
    - name: Run tests
      run: |
       cargo test --profile lto
       ls -hl target/*/BL
      
    - name: Upload files to a GitHub release
      uses: svenstaro/upload-release-action@2.5.0
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: target/lto/BL 
        asset_name: Linux
        tag: Stable
        overwrite: true
        body: "Ubuntu Linux binary executable."
      
  macOS:
    name: Building on macOS. 
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v3

    - name: Rust Update
      run: rustup update
      
    - name: Rust Cache
      uses: Swatinem/rust-cache@v2.2.1
      
    - name: Build release
      run: |
        cargo update
        #time cargo br
        time cargo lto
        ls -hl target/*/BL
        sw_vers
        hostinfo
        sysctl -a | grep brand
        
    - name: Run tests
      run: |
       cargo test --profile lto
       ls -hl target/*/BL
      
    - name: Upload files to a GitHub release
      uses: svenstaro/upload-release-action@2.5.0
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: target/lto/BL
        asset_name: macOS
        tag: Stable
        overwrite: true
        body: "macOS binary executable."
      
  Windows:
    name: Building on Windows. 
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - name: Rust Update
      run: rustup update
        
    - name: Rust Cache
      uses: Swatinem/rust-cache@v2.2.1
      
    - name: Build release
      run: |   
        #cargo br
        cargo lto
        dir target/*/*.exe
        systeminfo
        
    - name: Run tests
      run: |
       cargo test --profile lto
       ls -hl target/*/BL
      
    - name: Upload files to a GitHub release
      uses: svenstaro/upload-release-action@2.5.0
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: target/lto/BL.exe
        asset_name: Windows.exe
        tag: Stable
        overwrite: true
        body: "Windows binary executable."
